name: Auto-merge when checks pass

on:
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ["Create PR for Claude branches"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    runs-on: ubuntu-latest
    # Only run if checks succeeded
    if: github.event.check_suite.conclusion == 'success' || github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Merge Claude PRs
        uses: actions/github-script@v7
        with:
          script: |
            // Find open PRs from claude/* branches
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'main'
            });

            for (const pr of prs) {
              // Only merge PRs from claude/* branches
              if (!pr.head.ref.startsWith('claude/')) {
                continue;
              }

              console.log(`Checking PR #${pr.number} from ${pr.head.ref}`);

              // Check if all checks have passed
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });

              const pendingChecks = checks.check_runs.filter(
                check => check.status !== 'completed'
              );

              const failedChecks = checks.check_runs.filter(
                check => check.status === 'completed' &&
                         check.conclusion !== 'success' &&
                         check.conclusion !== 'skipped' &&
                         check.conclusion !== 'neutral'
              );

              if (pendingChecks.length > 0) {
                console.log(`PR #${pr.number}: ${pendingChecks.length} checks still pending`);
                continue;
              }

              if (failedChecks.length > 0) {
                console.log(`PR #${pr.number}: ${failedChecks.length} checks failed`);
                continue;
              }

              // All checks passed - merge!
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  merge_method: 'squash'
                });
                console.log(`âœ… Merged PR #${pr.number}`);
              } catch (error) {
                console.log(`Failed to merge PR #${pr.number}: ${error.message}`);
              }
            }
